<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Donation Listings | Alay AKAP</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root {
  --accent: #df1360;
  --pink: #e91e63;
  --bg: #e7e7e7;
  --light-gray: #f2f2f2;
  --text-dark: #111;
  --gray: #ccc;
  --muted: #f4f4f4;
  --card-border: #ff7aa6;
}

body {
  margin:0;
  font-family: "Poppins", sans-serif;
  display:flex;
  background: var(--bg);
  color: var(--text-dark);
  min-height:100vh;
}

.sidebar {
  width: 100px;
  background: var(--accent);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 24px 0;
  gap: 18px; /* <-- ADDED THIS */
  flex-shrink: 0;
  position: fixed; /* <-- CHANGED THIS */
  top: 0;
  left: 0;
  height: 100vh;
  z-index: 100; /* <-- ADDED THIS */
}
.logo-placeholder {
  width:80px; height:80px;
  background:white; border-radius:8px;
  margin-bottom:20px;
  display:flex; justify-content:center; align-items:center;
  font-size:10px; font-weight:700; color: var(--accent);
}
.nav-item { width:100%; }
.icon-link {
  display:flex; justify-content:center; align-items:center;
  width:100%; height:65px; text-decoration:none; color:white;
  transition: background 0.18s ease;
}
.icon-link i { font-size:28px; }
.icon-link:hover { background: rgba(0,0,0,0.1); }
.icon-link.active {
  background:#fff;
  color: var(--accent);
  border-right:5px solid white;
  transform: translateY(-2px);
}

main.main {
  flex:1;
  padding:36px;
  margin-left: 100px;
}
h1.title{
  font-weight: 900; font-size: 36px; margin: 0 0 8px;
}
.accent-line {
  width: 180px; height: 6px; background: var(--accent); border-radius: 4px; margin: 12px 0 24px;
}

.controls {
  display:flex;
  flex-direction: column;
  gap:12px;
  margin-bottom:20px;
}
.controls-top {
  display:flex; justify-content:space-between; align-items:center;
  flex-wrap:wrap;
}
.categories {
  display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  margin-top:6px;
}
.pill {
  border:2px solid #ddc;
  background:white;
  padding:8px 16px;
  border-radius:999px;
  font-weight:600;
  cursor:pointer;
}
.pill.active { background:var(--pink); color:white; border-color:var(--pink); }
.search-wrap {
  display:flex; gap:1px; align-items:center;
}
.search-input{
  border-radius:36px;
  padding:10px 18px;
  border:2px solid #ddd;
  width:250px;
  background:white;
}
.search-btn{
  width:44px; height:44px; border-radius:22px; background:white; color:white; border:none;
  display:flex; align-items:center; justify-content:center; font-weight:700;
}

.cards {
  display:grid;
  grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
  gap:22px;
  margin-top:22px;
}
.card-item{
  background:white;
  border-radius:28px;
  padding:18px;
  border:3px solid transparent;
  position:relative;
  overflow:hidden;
  min-height:150px;
  display:flex;
  gap:12px;
  align-items:center;
}
.card-item .thumb{
  width:96px; height:96px; border-radius:12px;
  background:#fafafa; display:flex; align-items:center; justify-content:center; overflow:hidden;
  border:4px solid var(--card-border);
}
.card-item .thumb img{ width:100%; height:100%; object-fit:contain; }
.card-item .info{ flex:1; padding-left:6px; }
.card-item .title{ font-weight:800; font-size:18px; margin-bottom:6px; }
.card-item .cat{ color:#777; font-size:13px; margin-bottom:10px; }
.card-actions{ display:flex; gap:10px; align-items:center; margin-top:6px; }
.btn-view { background:none; border:none; color:var(--pink); font-weight:700; cursor:pointer; padding:8px 10px; }
.btn-donate { background:var(--pink); border:none; color:white; padding:8px 14px; border-radius:999px; font-weight:700; cursor:pointer; }
.card-outline { border:3px solid var(--card-border); border-radius:24px; padding:12px; }

.empty-state{ text-align:center; padding:48px; border:1px solid #eee; border-radius:10px; background:white; margin-top:18px; }

.modal-content { border-radius:20px; overflow:hidden; }
.modal-header { background:var(--pink); color:white; border-bottom:none; }
.modal-title { font-weight:800; }
.modal-body { padding:18px; }
.modal-footer { border-top:none; padding:18px; justify-content:center; }
.details-box .modal-content { background:var(--pink); color:white; text-align:left; padding:22px; }
.details-box .btn { border-radius:26px; padding:8px 18px; }

@media (max-width:900px){
  .search-input{ width:100%; }
}
</style>
</head>
<body>

<aside class="sidebar">
  <div class="logo-placeholder" style="background-color: transparent; border: none;">
    <img src="logo.png" alt="AlayAkap Logo" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">
</div>
  <div class="nav-item"><a href="Homepage.html" class="icon-link"><i class="fa-solid fa-house"></i></a></div>
  <div class="nav-item"><a href="donation_listing.html" class="icon-link active"><i class="fa-solid fa-list"></i></a></div>
  <div class="nav-item"><a href="donor_dashboard.html" class="icon-link"><i class="fa-solid fa-handshake"></i></a></div>
  <div class="nav-item"><a href="recipient_dashboard.html" class="icon-link"><i class="fa-solid fa-hand-holding-heart"></i></a></div>
  <div class="nav-item"><a href="notifications.html" class="icon-link"><i class="fa-solid fa-bell"></i></a></div>
</aside>

<main class="main container-fluid">
  <h1 class="title">DONATION LISTINGS</h1>
  <div class="accent-line"></div>

  <div class="controls">
    <div class="controls-top">
      <div style="font-weight:800; color:#555;">CATEGORIES:</div>
      <div class="search-wrap">
        <input id="searchInput" class="search-input" placeholder="Search..." />
        <button id="searchBtn" class="search-btn" title="Search">üîç</button>
      </div>
    </div>
    <div class="categories" id="categoriesWrap"></div>
  </div>

  <div id="cardsContainer">
    <div class="cards" id="cardsGrid"></div>
    <div id="emptyState" style="display:none;">
      <div class="empty-state">
        <img src="https://cdn-icons-png.flaticon.com/512/2748/2748558.png" alt="no results" style="width:220px; opacity:0.9; margin-bottom:18px;">
        <h4 style="color:#666; font-weight:700;">No donations matched your search.</h4>
        <p style="color:#999;">Try a different keyword or browse categories.</p>
        <button id="browseBtn" class="btn" style="background:var(--pink); color:white; border-radius:28px; padding:10px 20px; font-weight:800;">Browse Categories</button>
      </div>
    </div>
  </div>
</main>

<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Donation</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="confirmForm">
          <div class="mb-3">
            <label class="form-label">Donor Name</label>
            <input id="donorName" class="form-control" placeholder="Enter your name (required)" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Phone or Email</label>
            <input id="donorContact" class="form-control" placeholder="Enter phone or email (required)" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Item to Donate</label>
            <input id="donationItem" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input id="donationQty" type="number" class="form-control" placeholder="Enter how many items (required)" min="1">
          </div>
          <div class="mb-3">
            <label class="form-label">Preferred Delivery Option</label><br>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="deliveryOpt" id="optDrop" value="Drop-off" checked>
              <label class="form-check-label" for="optDrop">Drop-off</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="deliveryOpt" id="optMeet" value="Meet-up">
              <label class="form-check-label" for="optMeet">Meet-up</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="deliveryOpt" id="optPick" value="Pick-up">
              <label class="form-check-label" for="optPick">Pick-up</label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="submitDonation" class="btn" style="background:var(--pink); color:white; font-weight:800;">Submit Donation</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade details-box" id="detailsModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <h4 style="font-weight:900; margin-bottom:12px;">Request Details</h4>
        <p id="detailRequestedBy" style="margin-bottom:6px;"><strong>Requested by:</strong> ‚Äî</p>
        <p id="detailLocation" style="margin-bottom:6px;"><strong>Location:</strong> ‚Äî</p>
        <p id="detailDate" style="margin-bottom:6px;"><strong>Date Requested:</strong> ‚Äî</p>
        <p id="detailStatus" style="margin-bottom:14px;"><strong>Status:</strong> ‚Äî</p>
        <div style="display:flex; gap:12px; justify-content:center;">
          <button class="btn btn-light" data-bs-dismiss="modal" style="border-radius:26px; font-weight:700;">Close</button>
          <button id="donateFromDetails" class="btn" style="background:var(--pink); color:white; border-radius:26px; font-weight:800;">Donate Now</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  
    <script src="storage.js"></script>
    <script src="auth.js"></script>
    <script>
// ========== DONATION LISTING SCRIPT ==========

document.addEventListener('DOMContentLoaded', () => {
    // --- Modal References ---
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

    // --- Element References ---
    const cardsGrid = document.getElementById('cardsGrid');
    const emptyState = document.getElementById('emptyState');
    const categoriesWrap = document.getElementById('categoriesWrap');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');

    // --- Form References ---
    const confirmForm = document.getElementById('confirmForm');
    const donorNameInput = document.getElementById('donorName');
    const donorContactInput = document.getElementById('donorContact');
    const donationItemInput = document.getElementById('donationItem');
    const donationQtyInput = document.getElementById('donationQty');
    const submitDonationBtn = document.getElementById('submitDonation');
    
    // --- Details Modal References ---
    const detailRequestedBy = document.getElementById('detailRequestedBy');
    const detailLocation = document.getElementById('detailLocation');
    const detailDate = document.getElementById('detailDate');
    const detailStatus = document.getElementById('detailStatus');
    const donateFromDetailsBtn = document.getElementById('donateFromDetails');

    let allRequests = [];
    let currentCategory = 'All';
    let currentSearch = '';
    let currentRequestId = null; // To track which item is being donated
    let currentRequestTitle = ''; // To track item title for the modal

    // --- Main Render Function ---
    function renderListings() {
        if (!cardsGrid || !emptyState) return;

        // 1. Get filtered data
        const filteredRequests = allRequests.filter(req => {
            const matchesCategory = (currentCategory === 'All' || req.category === currentCategory);
            const matchesSearch = (!currentSearch || req.title.toLowerCase().includes(currentSearch) || req.category.toLowerCase().includes(currentSearch));
            const matchesStatus = (req.status.toLowerCase() === 'active'); // Only show active requests
            return matchesCategory && matchesSearch && matchesStatus;
        });

        // 2. Check for empty state
        if (filteredRequests.length === 0) {
            cardsGrid.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }
        emptyState.style.display = 'none';

        // 3. Generate and render HTML
        cardsGrid.innerHTML = filteredRequests.map(req => `
            <div class="col">
                <div class="card-outline">
                    <div class="card-item">
                        <div class="thumb">
                            <img src="${req.img}" alt="${escapeHtml(req.title)}">
                        </div>
                        <div class="info">
                            <div class="title">${escapeHtml(req.title)}</div>
                            <div class="cat">${escapeHtml(req.category)}</div>
                            <div class="card-actions">
                                <button class="btn-view" data-id="${req.id}">View</button>
                                <button class="btn-donate" data-id="${req.id}" data-title="${escapeHtml(req.title)}">Donate</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // --- Filter & Search ---
    function renderCategories() {
        if (!categoriesWrap) return;

        const categories = ['All', ...new Set(allRequests.map(req => req.category))];
        categoriesWrap.innerHTML = categories.map(cat => `
            <div class="pill ${cat === currentCategory ? 'active' : ''}" data-category="${cat}">
                ${escapeHtml(cat)}
            </div>
        `).join('');
    }

    function handleSearch() {
        currentSearch = searchInput.value.toLowerCase();
        renderListings();
    }

    // --- Event Handlers ---
    categoriesWrap.addEventListener('click', (e) => {
        if (e.target.classList.contains('pill')) {
            currentCategory = e.target.dataset.category;
            renderCategories();
            renderListings();
        }
    });

    searchBtn.addEventListener('click', handleSearch);
    searchInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') handleSearch();
    });
    
    document.getElementById('browseBtn').addEventListener('click', () => {
        currentCategory = 'All';
        currentSearch = '';
        searchInput.value = '';
        renderCategories();
        renderListings();
    });

    cardsGrid.addEventListener('click', (e) => {
        const target = e.target;
        
        if (target.classList.contains('btn-view')) {
            const requestId = target.dataset.id;
            const request = allRequests.find(r => r.id === requestId);
            if (request) {
                // Populate and show details modal
               // Corrected code using template literals and bold tags:
detailRequestedBy.innerHTML = `<strong>Requested by:</strong> ${escapeHtml(request.requestedBy || 'N/A')}`;
detailLocation.innerHTML = `<strong>Location:</strong> ${escapeHtml(request.location || 'N/A')}`;
detailDate.innerHTML = `<strong>Date Requested:</strong> ${escapeHtml(request.date || 'N/A')}`;
detailStatus.innerHTML = `<strong>Status:</strong> ${escapeHtml(request.status || 'N/A')}`;
                
                // Set the "Donate" button in this modal to have the right ID
                donateFromDetailsBtn.dataset.id = request.id;
                donateFromDetailsBtn.dataset.title = request.title;
                
                detailsModal.show();
            }
        }
        
        if (target.classList.contains('btn-donate')) {
            currentRequestId = target.dataset.id;
            currentRequestTitle = target.dataset.title;
            
            // Populate and show confirm modal
            donationItemInput.value = currentRequestTitle;
            donationQtyInput.value = '1'; // Default to 1
            donorNameInput.value = '';
            donorContactInput.value = '';
            
            confirmModal.show();
        }
    });
    
    // Handle "Donate" button click from *within* the details modal
    donateFromDetailsBtn.addEventListener('click', (e) => {
        currentRequestId = e.target.dataset.id;
        currentRequestTitle = e.target.dataset.title;

        // Populate and show confirm modal
        donationItemInput.value = currentRequestTitle;
        donationQtyInput.value = '1';
        donorNameInput.value = '';
        donorContactInput.value = '';

        detailsModal.hide();
        confirmModal.show();
    });

    // Handle the final donation submission
    submitDonationBtn.addEventListener('click', () => {
        const currentUser = window.StorageManager.getCurrentUser();
        if (!currentUser) {
            alert('Please login to make a donation.');
            window.location.href = 'Login_Signup.html';
            return;
        }

        const donorName = donorNameInput.value.trim();
        const donorContact = donorContactInput.value.trim();
        const quantity = parseInt(donationQtyInput.value, 10);
        
        if (!donorName || !donorContact) {
            alert('Please fill in your name and contact information.');
            return;
        }
        if (isNaN(quantity) || quantity < 1) {
            alert('Please enter a valid quantity.');
            return;
        }
        if (!currentRequestId) {
            alert('Error: No request selected.');
            return;
        }
        
        const originalRequest = allRequests.find(r => r.id === currentRequestId);
        if (!originalRequest) {
            alert('Error: Could not find original request.');
            return;
        }

        // 1. Create a new donation object
        const newDonation = {
            title: currentRequestTitle,
            category: originalRequest.category,
            quantity: quantity,
            status: 'Pending',
            date: new Date().toISOString().split('T')[0],
            donorId: currentUser.id,
            donorName: donorName,
            donorContact: donorContact,
            requestId: currentRequestId, // Link to the original request
            location: originalRequest.location
        };
        
        // 2. Add the donation to storage
        window.StorageManager.addDonation(newDonation);
        
        // 3. Update the original request's status to 'Pending'
        window.StorageManager.updateRequest(currentRequestId, { status: 'Pending' });

        alert('Donation submitted successfully! The recipient will be notified.');
        
        confirmModal.hide();
        loadInitialData(); // Reload all data to refresh the page
    });

    // --- Helper ---
    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/[&<>"']/g, (match) => {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[match];
        });
    }

    // --- Initial Load ---
    function loadInitialData() {
        allRequests = window.StorageManager.getAllRequests();
        renderCategories();
        renderListings();
    }

    loadInitialData();
});
</script>
</body>
</html>